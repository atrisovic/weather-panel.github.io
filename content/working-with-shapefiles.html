
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Constructing weather averages within spatial units</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Suggestions for work organization" href="suggestions.html" />
    <link rel="prev" title="Generating geographical unit data" href="geographical-unit-data.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/climate_estimate_logo.png" class="logo" alt="logo">
  
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="getting-started.html">
   Introduction to the Tutorial
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Weather and Climate Data
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="weather-and-climate-data.html">
   1. Using Weather and Climate Data
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Developing a reduced-form specification
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="reduced-form-specification.html">
   Developing a reduced-form specification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="functional-forms.html">
   Functional forms: pros, cons, and methods
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Weighting schemes
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="weighting-schemes.html">
   Weighting schemes
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Geographical unit data
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="geographical-unit-data.html">
   Generating geographical unit data
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Constructing weather averages within spatial units
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Suggestions for work organization
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="suggestions.html">
   Suggestions for work organization
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Contributors
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="contributors.html">
   Contributors
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/content/working-with-shapefiles.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/atrisovic/weather-panel.github.io/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/atrisovic/weather-panel.github.io//issues/new?title=Issue%20on%20page%20%2Fcontent/working-with-shapefiles.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/atrisovic/weather-panel.github.io/edit/master/content/working-with-shapefiles.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#approach-1-using-grid-cell-centers">
   Approach 1. Using grid cell centers
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#approach-2-allowing-for-partial-grid-cells">
   Approach 2. Allowing for partial grid cells
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#matching-geographical-unit-observations">
   Matching geographical unit observations
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="constructing-weather-averages-within-spatial-units">
<h1>Constructing weather averages within spatial units<a class="headerlink" href="#constructing-weather-averages-within-spatial-units" title="Permalink to this headline">¶</a></h1>
<p>At this point, you probably have a gridded spatiotemporal dataset of historical weather and economic output data specific to shapefile regions. The next step is construct the weather measures that will correspond to each of your economic data observations. To do this, you will need to construct a weighted average of the weather in each region for each timestep.</p>
<p>In some cases, there are tools available that will help you do this. If you are using area weighting (i.e., no weighting grid) and your grid is fine enough that every region fully contains at least one cell, one tool you can use is
<a class="reference external" href="http://www.matteodefelice.name/post/aggregating-gridded-data/">regionmask</a>.</p>
<p>If your situation is more complicated, or if you just want to know how to do it yourself, it is important to set up the mathematical process efficiently since this can be a computationally intensive step.</p>
<p>The regional averaging process is equivalent to a matrix transformation:
<span class="math notranslate nohighlight">\(w_\text{region} = A w_\text{gridded}\)</span></p>
<p>where <span class="math notranslate nohighlight">\(w_\text{region}\)</span> is a vector of weather values across
regions, in a given timestep; and <span class="math notranslate nohighlight">\(w_\text{gridded}\)</span> is a vector of
weather values across grid cells. Suppose there are <span class="math notranslate nohighlight">\(N\)</span> regions and
<span class="math notranslate nohighlight">\(R C\)</span> grid cells, then the transformation matrix <span class="math notranslate nohighlight">\(A\)</span> will be <span class="math notranslate nohighlight">\(N x
R C\)</span>. The <span class="math notranslate nohighlight">\(A\)</span> matrix does not change over time, so once you
calculate it, the process for generating each time step is faster.</p>
<p>Below, we sketch out two approaches to generating this matrix, but a few comments are common no matter how you generate it.</p>
<ol class="simple">
<li><p>The sum of entries across each row should be 1. Missing values can
cause reasonable-looking calculations to produce rows sums that are
less than one, so make sure you check.</p></li>
<li><p>This matrix is huge, but it is very sparse: most entries
are 0. Make sure to use a sparse matrix implementation (e.g.,
<code class="docutils literal notranslate"><span class="pre">sparseMatrix</span></code> in R, <code class="docutils literal notranslate"><span class="pre">scipy.sparse</span></code> in python, <code class="docutils literal notranslate"><span class="pre">sparse</span></code> in Matlab).</p></li>
<li><p>The <span class="math notranslate nohighlight">\(w_\text{gridded}\)</span> data starts as a matrix, but here we use
it as a vector. It is easy (in any language) to convert a matrix
to a vector with all of its values, but you need to be careful
about the order of the entries, and order the columns of <span class="math notranslate nohighlight">\(A\)</span> the
same way.</p></li>
</ol>
<div class="tabbed-set docutils">
<input checked="checked" id="d3cd224d-4720-40d9-be6b-d9410d76fe53" name="cd5fb13c-d26c-4366-b678-fbd33838448d" type="radio">
</input><label class="tabbed-label" for="d3cd224d-4720-40d9-be6b-d9410d76fe53">
R</label><div class="tabbed-content docutils">
<p>In R, <code class="docutils literal notranslate"><span class="pre">as.vector</span></code> will convert from a matrix to a vector, with each
<em>column</em> being listed in full before moving on to the next column.</p>
</div>
<input id="7bffb969-c9dc-44a4-8a9f-7f07152c726d" name="cd5fb13c-d26c-4366-b678-fbd33838448d" type="radio">
</input><label class="tabbed-label" for="7bffb969-c9dc-44a4-8a9f-7f07152c726d">
Python</label><div class="tabbed-content docutils">
<p>In python, <code class="docutils literal notranslate"><span class="pre">numpy.flatten</span></code> will convert a numpy matrix to a vector,
with each <em>row</em> being listed in full before moving on to the next
row.</p>
</div>
<input id="71b47b3f-3957-4660-b30a-fc87ff5b833a" name="cd5fb13c-d26c-4366-b678-fbd33838448d" type="radio">
</input><label class="tabbed-label" for="71b47b3f-3957-4660-b30a-fc87ff5b833a">
Matlab</label><div class="tabbed-content docutils">
<p>In Matlab, indexing the grid with <code class="docutils literal notranslate"><span class="pre">(:)</span></code> will convert from an array
to a vector, with each <em>column</em> being listed in full before moving
on to the next column.</p>
</div>
</div>
<div class="section" id="approach-1-using-grid-cell-centers">
<h2>Approach 1. Using grid cell centers<a class="headerlink" href="#approach-1-using-grid-cell-centers" title="Permalink to this headline">¶</a></h2>
<p>The easiest way to generate weather for each region in a shapefile is
to generate a collection of points at the center of each grid
cell. This approach can be used without generating an <span class="math notranslate nohighlight">\(A\)</span> matrix,
but the matrix method improves efficiency.</p>
<p>As an example, in R, you generate these points like so:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">longitudes</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="n">longitude0</span><span class="p">,</span> <span class="n">longitude1</span><span class="p">,</span> <span class="n">gridwidth</span><span class="p">)</span>
<span class="n">latitudes</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="n">latitude0</span><span class="p">,</span> <span class="n">latitude1</span><span class="p">,</span> <span class="n">gridwidth</span><span class="p">)</span>
<span class="n">pts</span> <span class="o">&lt;-</span> <span class="nf">expand.grid</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">longitudes</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">latitudes</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, you can iterate through each region, and get a list of all of the
points within each region. Here’s how you would do that with the
<code class="docutils literal notranslate"><span class="pre">PBSmapping</span></code> library in R:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">events</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">EID</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span> <span class="n">X</span><span class="o">=</span><span class="n">pts</span><span class="o">$</span><span class="n">x</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">pts</span><span class="o">$</span><span class="n">y</span><span class="p">)</span>
<span class="n">events</span> <span class="o">&lt;-</span> <span class="nf">as.EventData</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="nf">attributes</span><span class="p">(</span><span class="n">polys</span><span class="p">)</span><span class="o">$</span><span class="n">projection</span><span class="p">)</span>
<span class="n">eids</span> <span class="o">&lt;-</span> <span class="nf">findPolys</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">polys</span><span class="p">,</span> <span class="n">maxRows</span><span class="o">=</span><span class="m">6e5</span><span class="p">)</span>
</pre></div>
</div>
<p>Then you can use the cells that have been found (which, if you’ve set
it up right, will be in the same order as the columns of <span class="math notranslate nohighlight">\(A\)</span>) to
fill in the entries of your transformation matrix.</p>
<p>If your regions are not much bigger than the grid cells, you may get
regions that do not contain any cell centers. In this case, you need
to find whichever grid cell is closest. For example, in R, using
<code class="docutils literal notranslate"><span class="pre">PBSmapping</span></code>:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">centroid</span> <span class="o">&lt;-</span> <span class="nf">calcCentroid</span><span class="p">(</span><span class="n">polys</span><span class="p">,</span> <span class="n">rollup</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="n">dists</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">((</span><span class="n">pts</span><span class="o">$</span><span class="n">x</span> <span class="o">-</span> <span class="n">centroid</span><span class="o">$</span><span class="n">X</span><span class="p">)</span><span class="o">^</span><span class="m">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">pts</span><span class="o">$</span><span class="n">y</span> <span class="o">-</span> <span class="n">centroid</span><span class="o">$</span><span class="n">Y</span><span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
<span class="n">closest</span> <span class="o">&lt;-</span> <span class="nf">which.min</span><span class="p">(</span><span class="n">dists</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="approach-2-allowing-for-partial-grid-cells">
<h2>Approach 2. Allowing for partial grid cells<a class="headerlink" href="#approach-2-allowing-for-partial-grid-cells" title="Permalink to this headline">¶</a></h2>
<p>Just using the grid cell centers can result in a poor representation
of the weather that overlaps each region, particularly when the
regions are of a similar size to the grid cells. In this case, you
need to determine how much each grid cell overlaps with each region.</p>
<p>There are different ways for doing this, but one is to use QGIS.
Within QGIS, you can create a shapefile with a rectangle for each grid
cell. Then intersect those with the region shapefile, producing a
separate polygon for each region-by-grid cell combination. Then have
QGIS compute the area of each of those regions: these will give you
the portion of grid cells to use.</p>
</div>
<div class="section" id="matching-geographical-unit-observations">
<h2>Matching geographical unit observations<a class="headerlink" href="#matching-geographical-unit-observations" title="Permalink to this headline">¶</a></h2>
<p>It is often necessary to match names within two datasets with geographical unit observations. For example, a country’s statistics ministry may report values by administrative unit, but to find out the actual spatial extent of those units, you may need to use the GADM shapefiles.</p>
<p>Matching observations by name can be very time-consuming. These problems even exist at the level of countries, where, for example, North Korea is regularly listed as “Democratic People’s Republic of Korea”, “Korea, North”, and “Korea, Dem. Rep.”; and information is indiscriminately reported for isolated regions or sovereign states (Guadeloupe’s data may or may not be included in France). Reporting units may not correspond to standard administrative units at all, and you will need to aggregate or disaggregate regions to match between datasets. Here are some suggestions for solving this problem:</p>
<ol class="simple">
<li><p>Try to perform all merging on abbreviation codes rather than names. At the level of countries, use <a class="reference external" href="https://www.nationsonline.org/oneworld/country_code_list.htm">ISO alpha-3 codes</a> if possible.</p></li>
<li><p>Use string matching. However, in this case, you will need to inspect all of the matches to make sure that they are correct.</p></li>
<li><p>Construct “translation functions” for each dataset, which map the regional names in that dataset to a canonical list of region names. For example, choose the names in one dataset as a canonical list, and name the matching functions as <code class="docutils literal notranslate"><span class="pre">&lt;dataset&gt;2canonical</span></code> and <code class="docutils literal notranslate"><span class="pre">canonical2&lt;dataset2&gt;</span></code>.</p></li>
</ol>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="geographical-unit-data.html" title="previous page">Generating geographical unit data</a>
    <a class='right-next' id="next-link" href="suggestions.html" title="next page">Suggestions for work organization</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>