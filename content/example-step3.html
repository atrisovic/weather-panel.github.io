

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Hands-on exercise, step 3: aggregating the data</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/example-step3';</script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Some pointers when performing regressions" href="regression-pointers.html" />
    <link rel="prev" title="Weighting schemes" href="weighting-schemes.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="getting-started.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/climate_estimate_logo.png" class="logo__image only-light" alt=" - Home"/>
    <script>document.write(`<img src="../_static/climate_estimate_logo.png" class="logo__image only-dark" alt=" - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="getting-started.html">
                    Introduction to the Tutorial
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Weather and climate data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="weather-and-climate-data.html">Introduction to weather and climate data</a></li>
<li class="toctree-l1"><a class="reference internal" href="netcdfs-and-basic-coding.html">Weather and climate data basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="gridded-data.html">Working with gridded data</a></li>
<li class="toctree-l1"><a class="reference internal" href="working-with-data-product.html">Choosing and downloading weather and climate data products</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-step1.html">Hands-on exercise, step 1: preparing the weather data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Developing a reduced-form specification</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="reduced-form-specification.html">Developing a reduced-form specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="functional-forms.html">Functional forms: pros, cons, and methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-step2.html">Hands-on exercise, step 2: preparing the demographic data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Geographical unit data</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="geographical-unit-data.html">Generating geographical unit data</a></li>
<li class="toctree-l1"><a class="reference internal" href="working-with-shapefiles.html">Constructing weather averages within spatial units</a></li>
<li class="toctree-l1"><a class="reference internal" href="weighting-schemes.html">Weighting schemes</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Hands-on exercise, step 3: aggregating the data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Bringing it all together</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="regression-pointers.html">Some pointers when performing regressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-step4.html">Hands-on exercise, step 4: regression results</a></li>
<li class="toctree-l1"><a class="reference internal" href="suggestions.html">Suggestions for work organization</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributors</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="contributors.html">Contributors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/atrisovic/weather-panel.github.io" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/atrisovic/weather-panel.github.io/edit/master/tutorial-content/content/example-step3.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/atrisovic/weather-panel.github.io/issues/new?title=Issue%20on%20page%20%2Fcontent/example-step3.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/content/example-step3.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Hands-on exercise, step 3: aggregating the data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-the-weather-data">Aggregating the weather data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-environment">Setting up the environment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transforming-the-data">Transforming the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-map-of-pixels-onto-polygons">Create map of pixels onto polygons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregate-values-onto-polygons">Aggregate values onto polygons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#export-this-as-a-csv-file-to-be-used-elsewhere">Export this as a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file to be used elsewhere</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="hands-on-exercise-step-3-aggregating-the-data">
<span id="content-hands-on3"></span><h1>Hands-on exercise, step 3: aggregating the data<a class="headerlink" href="#hands-on-exercise-step-3-aggregating-the-data" title="Permalink to this heading">#</a></h1>
<section id="aggregating-the-weather-data">
<h2>Aggregating the weather data<a class="headerlink" href="#aggregating-the-weather-data" title="Permalink to this heading">#</a></h2>
<p>There exist tools in R and Python which aggregate gridded data
according to a shapefile. In particular, <code class="docutils literal notranslate"><span class="pre">xagg</span></code> in Python and <code class="docutils literal notranslate"><span class="pre">stagg</span></code>
in R handle partial grid-cell overlapping and arbitrary weighting
grid, and we recommend that it be used irrespective of the language
being used elsewhere.</p>
</section>
<section id="setting-up-the-environment">
<h2>Setting up the environment<a class="headerlink" href="#setting-up-the-environment" title="Permalink to this heading">#</a></h2>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
Python</label><div class="sd-tab-content docutils">
<p>The approach uses <code class="docutils literal notranslate"><span class="pre">xarray</span></code> for gridded data, <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> to work with shapefiles, and <code class="docutils literal notranslate"><span class="pre">xagg</span></code> to aggregate gridded data onto shapefiles.</p>
<p>Install <code class="docutils literal notranslate"><span class="pre">xagg</span></code> according to <a class="reference external" href="https://github.com/ks905383/xagg">the instructions from
GitHub</a>.</p>
<p>You will need to download a shapefile for the US counties. We use one
from the ESRI community website:
<a class="reference external" href="https://community.esri.com/ccqpr47374/attachments/ccqpr47374/enterprise-portal/4124/1/UScounties.zip">https://community.esri.com/ccqpr47374/attachments/ccqpr47374/enterprise-portal/4124/1/UScounties.zip</a></p>
<p>Save its contents to a folder <code class="docutils literal notranslate"><span class="pre">geo_data</span></code> in the <code class="docutils literal notranslate"><span class="pre">data</span></code> directory. The
following code should be run from the <code class="docutils literal notranslate"><span class="pre">data</span></code> directory.</p>
<p>Begin your code as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">xagg</span> <span class="k">as</span> <span class="nn">xa</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
R</label><div class="sd-tab-content docutils">
<p>The approach uses <code class="docutils literal notranslate"><span class="pre">raster</span></code> to work with gridded data, <code class="docutils literal notranslate"><span class="pre">tigris</span></code> to work
with shapefiles, and <code class="docutils literal notranslate"><span class="pre">stagg</span></code> to aggregate gridded data onto shapefiles.</p>
<p>Install <code class="docutils literal notranslate"><span class="pre">stagg</span></code> according to <a class="reference external" href="https://github.com/tcarleton/stagg">the instructions from
GitHub</a>.</p>
<p>Begin your code as follows:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">stagg</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tigris</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, load the data from the previous steps and the county shapefile:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-2" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-2">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load temperature data using xarray</span>
<span class="n">ds_tas</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
    <span class="s1">&#39;../data/climate_data/tas_day_BEST_historical_station_19800101-19891231.nc&#39;</span><span class="p">)</span>

<span class="c1"># Load population data using xarray </span>
<span class="n">ds_pop</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;../data/pcount/usap90ag.nc&#39;</span><span class="p">)</span>

<span class="c1"># Load county shapefiles using geopandas</span>
<span class="n">gdf_counties</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;../data/geo_data/UScounties.shp&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-3" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-3">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1">## Load data and expand to global grid</span>
<span class="n">global.extent</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">extent</span><span class="p">(</span><span class="m">-180</span><span class="p">,</span><span class="w"> </span><span class="m">180</span><span class="p">,</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="m">90</span><span class="p">)</span>

<span class="n">rr.tas</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">stack</span><span class="p">(</span><span class="s">&quot;../data/climate_data/tas_day_BEST_historical_station_19800101-19891231.nc&quot;</span><span class="p">)</span>
<span class="n">rr.tas.padded</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">extend</span><span class="p">(</span><span class="n">rr.tas</span><span class="p">,</span><span class="w"> </span><span class="n">global.extent</span><span class="p">)</span>
<span class="n">rr.pop</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">raster</span><span class="p">(</span><span class="s">&quot;../data/pcount/usap90ag.nc&quot;</span><span class="p">)</span>
<span class="n">rr.pop.padded</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">extend</span><span class="p">(</span><span class="n">rr.pop</span><span class="p">,</span><span class="w"> </span><span class="n">global.extent</span><span class="p">)</span>
<span class="n">rr.pop.padded</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">rr.pop.padded</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="c1">## Load counties</span>
<span class="n">counties</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tigris</span><span class="o">::</span><span class="nf">counties</span><span class="p">()</span>
<span class="n">counties</span><span class="o">$</span><span class="n">FIPS</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">counties</span><span class="o">$</span><span class="n">STATEFP</span><span class="p">,</span><span class="w"> </span><span class="n">counties</span><span class="o">$</span><span class="n">COUNTYFP</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="transforming-the-data">
<h2>Transforming the data<a class="headerlink" href="#transforming-the-data" title="Permalink to this heading">#</a></h2>
<p>Next, we need to construct any nonlinear transformations of the data.</p>
<p>For our econometric model, we want temperature in both linear and quadratic form, centered around <span class="math notranslate nohighlight">\(20^\circ\)</span> C: <span class="math notranslate nohighlight">\(T-20^\circ C\)</span> and <span class="math notranslate nohighlight">\(T^2 - (20^\circ C)^2\)</span>.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-4" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-4">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds_tas</span><span class="p">[</span><span class="s1">&#39;tas_adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_tas</span><span class="o">.</span><span class="n">tas</span><span class="o">-</span><span class="mi">20</span>
<span class="n">ds_tas</span><span class="p">[</span><span class="s1">&#39;tas_sq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_tas</span><span class="o">.</span><span class="n">tas</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">20</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># xagg aggregates every gridded variable in ds_tas - however, we don&#39;t need</span>
<span class="c1"># every variable currently in tas. Let&#39;ss drop &quot;tas&quot; (the un-adjusted temperature)</span>
<span class="c1"># and &quot;land_mask&quot; which is included, but not necessary for our further analysis.</span>
<span class="n">ds_tas</span> <span class="o">=</span> <span class="n">ds_tas</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;tas&#39;</span><span class="p">)</span>
<span class="n">ds_tas</span> <span class="o">=</span> <span class="n">ds_tas</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;land_mask&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-5" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-5">
R</label><div class="sd-tab-content docutils">
<p>With <code class="docutils literal notranslate"><span class="pre">stagg</span></code>, we will let the library handle this with the
<code class="docutils literal notranslate"><span class="pre">staggregate_polynomial</span></code> function (below).</p>
</div>
</div>
</section>
<section id="create-map-of-pixels-onto-polygons">
<h2>Create map of pixels onto polygons<a class="headerlink" href="#create-map-of-pixels-onto-polygons" title="Permalink to this heading">#</a></h2>
<p>We need to create a weight map of pixels to polygons. For each
polygon, we need to know which pixels overlap it and by how much.</p>
<p><code class="docutils literal notranslate"><span class="pre">xagg</span></code> and <code class="docutils literal notranslate"><span class="pre">stagg</span></code> do this by creating polygons for each pixel in the
gridded dataset, taking the intersect between each county polygon and
all pixel polygons, and calculating the average area of overlap
between the pixels that touch the polygon and the polygon.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-6" name="sd-tab-set-3" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-6">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">weightmap</span> <span class="o">=</span> <span class="n">xa</span><span class="o">.</span><span class="n">pixel_overlaps</span><span class="p">(</span><span class="n">ds_tas</span><span class="p">,</span> <span class="n">gdf_counties</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">ds_pop</span><span class="o">.</span><span class="n">Population</span><span class="p">,</span> <span class="n">subset_bbox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-7" name="sd-tab-set-3" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-7">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">grid.weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">secondary_weights</span><span class="p">(</span><span class="n">secondary_raster</span><span class="o">=</span><span class="n">rr.pop.padded</span><span class="p">,</span><span class="w"> </span><span class="n">grid</span><span class="o">=</span><span class="n">rr.tas.padded</span><span class="p">)</span>
<span class="n">county.weights</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">overlay_weights</span><span class="p">(</span><span class="n">polygons</span><span class="o">=</span><span class="n">counties</span><span class="p">,</span><span class="w"> </span><span class="n">polygon_id_col</span><span class="o">=</span><span class="s">&quot;FIPS&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">grid</span><span class="o">=</span><span class="n">rr.tas.padded</span><span class="p">,</span><span class="w"> </span><span class="n">secondary_weights</span><span class="o">=</span><span class="n">grid.weights</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="aggregate-values-onto-polygons">
<h2>Aggregate values onto polygons<a class="headerlink" href="#aggregate-values-onto-polygons" title="Permalink to this heading">#</a></h2>
<p>For each county, we want to calculate the weighted average of the temperatures of the pixels that cover the county. Since we included population as a desired weight above, the weight for each pixel is a combination of how much of the pixel overlaps with the county and its population density. In other words, a pixel that covers more of a county and has a higher population density will be weighted more in that county’s temperature average than a pixel that covers less of a county and is more sparsely populated.</p>
<p>The output of this step now gives, for each county, a 10-year time series of linear and quadratic temperature, properly area- and population-weighted.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-8" name="sd-tab-set-4" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-8">
Python</label><div class="sd-tab-content docutils">
<p>Using the weight map calculated above, <code class="docutils literal notranslate"><span class="pre">xagg</span></code> now aggregates all the
gridded variables in <code class="docutils literal notranslate"><span class="pre">ds_tas</span></code> (the <code class="docutils literal notranslate"><span class="pre">tas_adj</span></code> and <code class="docutils literal notranslate"><span class="pre">tas_sq</span></code> we
calculated above) onto the county polygons.</p>
<p><code class="docutils literal notranslate"><span class="pre">aggregated</span></code> is an object specific to the <code class="docutils literal notranslate"><span class="pre">xagg</span></code> package. We need to
modify it to be usable, for example using <code class="docutils literal notranslate"><span class="pre">aggregated.to_dataset()</span></code> or
<code class="docutils literal notranslate"><span class="pre">aggregated.to_csv()</span></code>. See the <code class="docutils literal notranslate"><span class="pre">xagg</span></code> docs for more info. Here we use
<code class="docutils literal notranslate"><span class="pre">aggregated.to_dataset()</span></code> which produces an <code class="docutils literal notranslate"><span class="pre">xarray</span></code> dataset, which
will be convenient for providing a standardized output.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">aggregated</span> <span class="o">=</span> <span class="n">xa</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">ds_tas</span><span class="p">,</span> <span class="n">weightmap</span><span class="p">)</span>

<span class="c1">## Aggregate the result to the annual level</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
<span class="n">ds2</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-9" name="sd-tab-set-4" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-9">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1">## Shift axis of climate data to conform to stagg expectations</span>
<span class="n">rr.tas.padded2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">shift</span><span class="p">(</span><span class="n">rr.tas.padded</span><span class="p">,</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">360</span><span class="p">)</span>

<span class="c1">## Calculate aggregation</span>
<span class="n">county.tas</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">staggregate_polynomial</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">rr.tas.padded2</span><span class="p">,</span><span class="w"> </span><span class="n">daily_agg</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time_agg</span><span class="o">=</span><span class="s">&#39;year&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">overlay_weights</span><span class="o">=</span><span class="n">county.weights</span><span class="p">,</span><span class="w"> </span><span class="n">degree</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="export-this-as-a-csv-file-to-be-used-elsewhere">
<h2>Export this as a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file to be used elsewhere<a class="headerlink" href="#export-this-as-a-csv-file-to-be-used-elsewhere" title="Permalink to this heading">#</a></h2>
<p>Finally, we need to export this data to be used elsewhere. For this tutorial, we want to allow a variety of tools, so we’ll
export the aggregated data into a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> (comma-separated value) file,
which can easily be read by R, STATA, and most other programming
tools.</p>
<p>The result from <code class="docutils literal notranslate"><span class="pre">xagg</span></code> will be reshaped ‘wide’ - so every row is a
county, and every column is a timestep of the variables. <code class="docutils literal notranslate"><span class="pre">stagg</span></code> on
the other hand aggregates the results to the annual level and provides
each county-year as a row. We also want to output this data in a
standard form, so that the next step does not depend on the language
and library used for this step.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-10" name="sd-tab-set-5" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-10">
Python</label><div class="sd-tab-content docutils">
<p>Use <code class="docutils literal notranslate"><span class="pre">aggregated.to_dataset()</span></code> or <code class="docutils literal notranslate"><span class="pre">aggregated.to_dataframe()</span></code>,
depending on whether you’d like to continue using it in <code class="docutils literal notranslate"><span class="pre">xarray</span></code> or
<code class="docutils literal notranslate"><span class="pre">pandas</span></code>. The code below provides a standard format for the next step.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds2</span><span class="p">[</span><span class="s1">&#39;STATE_FIPS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds2</span><span class="o">.</span><span class="n">STATE_FIPS</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">ds2</span><span class="p">[</span><span class="s1">&#39;CNTY_FIPS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds2</span><span class="o">.</span><span class="n">CNTY_FIPS</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">ds2</span><span class="p">[</span><span class="s1">&#39;FIPS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">ds2</span><span class="o">.</span><span class="n">STATE_FIPS</span><span class="p">,</span> <span class="n">ds2</span><span class="o">.</span><span class="n">CNTY_FIPS</span><span class="p">)</span>
<span class="n">ds2</span><span class="p">[</span><span class="s1">&#39;FIPS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds2</span><span class="o">.</span><span class="n">FIPS</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>

<span class="n">ds2</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s1">&#39;poly_idx&#39;</span><span class="p">:</span> <span class="s1">&#39;FIPS&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;poly_idx&#39;</span><span class="p">)</span>
<span class="n">ds2</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;../data/climate_data/agg_vars.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-11" name="sd-tab-set-5" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-11">
R</label><div class="sd-tab-content docutils">
<p>The polynomial calculation used by <code class="docutils literal notranslate"><span class="pre">stagg</span></code> assumes a baseline
temperature of 0 C. We will now adjust this to a baseline of 20 C.</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1">## Only write out valid entries</span>
<span class="n">county.tas.valid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">county.tas</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">order_1</span><span class="p">))</span>

<span class="c1">## Remove 20 deg per day</span>
<span class="n">daysperyear</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="nf">substring</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">rr.tas</span><span class="p">),</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">))</span>
<span class="n">county.tas.base</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">daysperyear</span><span class="p">)),</span><span class="w"> </span><span class="n">order_1</span><span class="o">=</span><span class="m">20</span><span class="o">*</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">daysperyear</span><span class="p">),</span><span class="w"> </span><span class="n">order_2</span><span class="o">=</span><span class="p">(</span><span class="m">20</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">*</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">daysperyear</span><span class="p">))</span>

<span class="n">county.tas.final</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">county.tas.valid</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">left_join</span><span class="p">(</span><span class="n">county.tas.base</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="s">&#39;year&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">suffix</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;.base&#39;</span><span class="p">))</span>

<span class="n">county.tas.final</span><span class="o">$</span><span class="n">tas_adj</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">county.tas.final</span><span class="o">$</span><span class="n">order_1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">county.tas.final</span><span class="o">$</span><span class="n">order_1.base</span>
<span class="n">county.tas.final</span><span class="o">$</span><span class="n">tas_sq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">county.tas.final</span><span class="o">$</span><span class="n">order_2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">county.tas.final</span><span class="o">$</span><span class="n">order_2.base</span>
<span class="nf">names</span><span class="p">(</span><span class="n">county.tas.final</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&#39;FIPS&#39;</span>

<span class="nf">write.csv</span><span class="p">(</span><span class="n">county.tas.final</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;../data/climate_data/agg_vars.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="o">=</span><span class="bp">F</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="weighting-schemes.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Weighting schemes</p>
      </div>
    </a>
    <a class="right-next"
       href="regression-pointers.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Some pointers when performing regressions</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-the-weather-data">Aggregating the weather data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-environment">Setting up the environment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transforming-the-data">Transforming the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-map-of-pixels-onto-polygons">Create map of pixels onto polygons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregate-values-onto-polygons">Aggregate values onto polygons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#export-this-as-a-csv-file-to-be-used-elsewhere">Export this as a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file to be used elsewhere</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
&copy; 2020 - This work is licensed under CC-BY-SA-4.0 <br>
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>