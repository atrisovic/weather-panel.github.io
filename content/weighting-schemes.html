

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Weighting schemes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/weighting-schemes';</script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Hands-On Exercise, Step 3: Aggregating the data" href="example-step3.html" />
    <link rel="prev" title="Constructing weather averages within spatial units" href="working-with-shapefiles.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="getting-started.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/climate_estimate_logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/climate_estimate_logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="getting-started.html">
                    Introduction to the Tutorial
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Weather and Climate Data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="weather-and-climate-data.html">Using Weather and Climate Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="working-with-data-product.html">How to Start Working with a Data Product</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-step1.html">Hands-On Exercise, Step 1: Preparing the Weather Data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Developing a reduced-form specification</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="reduced-form-specification.html">Developing a reduced-form specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="functional-forms.html">Functional forms: pros, cons, and methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-step2.html">Hands-On Exercise, Step 2: Understanding the outcomes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Geographical unit data</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="geographical-unit-data.html">Generating geographical unit data</a></li>
<li class="toctree-l1"><a class="reference internal" href="working-with-shapefiles.html">Constructing weather averages within spatial units</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Weighting schemes</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-step3.html">Hands-On Exercise, Step 3: Aggregating the data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Bringing it all together</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="producing-results.html">Producing results</a></li>
<li class="toctree-l1"><a class="reference internal" href="example-step4.html">Hands-On Exercise, Step 4: Producing results</a></li>
<li class="toctree-l1"><a class="reference internal" href="suggestions.html">Suggestions for work organization</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributors</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="contributors.html">Contributors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/atrisovic/weather-panel.github.io" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/atrisovic/weather-panel.github.io/edit/master/tutorial-content/content/weighting-schemes.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/atrisovic/weather-panel.github.io/issues/new?title=Issue%20on%20page%20%2Fcontent/weighting-schemes.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/content/weighting-schemes.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Weighting schemes</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-spatial-weighting-schemes-matter">Why spatial weighting schemes matter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#where-to-get-spatial-weighting-data">Where to get spatial weighting data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-gridded-weighting-data">Working with gridded weighting data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-format-of-the-data-values">The format of the data values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-spatial-gridding-scheme">The spatial gridding scheme</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-geographic-projection">The geographic projection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-of-missing-data">Handling of missing data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-notes-reading-gridded-data">Implementation Notes: Reading gridded data.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aligning-weather-and-weighting-grids">Aligning weather and weighting grids</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upsampling-increasing-data-resolution">Upsampling - increasing data resolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downsampling-decreasing-data-resolution">Downsampling - decreasing data resolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cropping-adjusting-the-extent-of-data">Cropping - adjusting the extent of data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example">Example</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-your-results">Plotting your results</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="weighting-schemes">
<h1>Weighting schemes<a class="headerlink" href="#weighting-schemes" title="Permalink to this heading">#</a></h1>
<p>This section describes how to use different weighting schemes when
working with gridded and regional data. As we use the term, weighting
schemes assign a weight to each grid cell or regional
observation. They have two major uses: (1) when running regressions,
to weight observations to accurately estimate processes, or (2) to
perform a weighted aggregation of gridded data to data regions.</p>
<section id="why-spatial-weighting-schemes-matter">
<h2>Why spatial weighting schemes matter<a class="headerlink" href="#why-spatial-weighting-schemes-matter" title="Permalink to this heading">#</a></h2>
<p>Taking the unweighted average of weather within a region can misrepresent what populations, firms, or other phenomena of interest are exposed to. For example, an unweighted annual average temperature for Canada is about -8°C, but most of the population and agricultural activity is in climate zones with mean temperatures over 6°C, and the urban heat island effect can raise temperatures by another 4°C. The time of year matters too, and you should consider a weighting scheme across days within a year, or even hours within a day.</p>
<p>As described in the section
<a class="reference internal" href="reduced-form-specification.html#content-spatial-and-temporal-scales"><span class="std std-ref">spatial and temporal scales of economic processes</span></a>,
the scale of a phenomenon matters. Many processes occur at a more
local scale than that which data is collected. The motivation for
weighting is different for aggregation that represents averaged
phenomena vs. phenomena that respond to averaged weather, and the
sequence of analysis changes accordingly.</p>
<p>When the phenomenon occurs locally, in response to local weather, we perform weighted aggregations to reflect the amount of the phenomenon in each location. For example, we would use population weighting to model the effects of heat on people. In this case, the order of operations is:</p>
<ol class="arabic simple">
<li><p>Transform weather into the terms of the model specification.</p></li>
<li><p>Average these transformed terms across space using a weighting scheme.</p></li>
</ol>
<p>When the phenomenon occurs at a data region level, in response to averaged weather, the weighting scheme reflects the relative importance of weather in different regions to the whole. For example, weighting rainfall by the distance from ashore could be important to predict the declaration of states of emergency. The order of operations is:</p>
<ol class="arabic simple">
<li><p>Average the weather across space using a weighting scheme.</p></li>
<li><p>Transform the averaged weather to the model specification.</p></li>
</ol>
<p>In either case, the weighting scheme is the same:</p>
<div class="math notranslate nohighlight">
\[T_{it} = \sum_{p \in P(i)} w_p T_{pt} \text{ such that } \sum_p w_{p \in P(i)} = 1 \,\,\,\forall i\]</div>
<p>where <span class="math notranslate nohighlight">\(w_p\)</span> is the weight for pixel <span class="math notranslate nohighlight">\(p\)</span>, and <span class="math notranslate nohighlight">\(P(i)\)</span> is the set of pixels in data region <span class="math notranslate nohighlight">\(i\)</span>.</p>
</section>
<section id="where-to-get-spatial-weighting-data">
<h2>Where to get spatial weighting data<a class="headerlink" href="#where-to-get-spatial-weighting-data" title="Permalink to this heading">#</a></h2>
<p>Below are some common data sources for various weighting schemes.</p>
<ul class="simple">
<li><p>📚  Population is an important weighting scheme for social impacts.</p>
<ul>
<li><p><a class="reference external" href="https://sedac.ciesin.columbia.edu/data/collection/gpw-v4">Gridded Population of the World</a>
: Open-source, available at 30 arc-second resolution every 5 years from 2000 (or before with their previous version).</p></li>
<li><p><a class="reference external" href="https://landscan.ornl.gov/landscan-datasets">LandScan</a>
: LandScan is available at 30 arc-second resolution, annually, but previous years need to be purchased. Ask at your institution, as many already have it.</p></li>
</ul>
</li>
<li><p>📚  Gridded agriculture information</p>
<ul>
<li><p><a class="reference external" href="https://sedac.ciesin.columbia.edu/data/collection/aglands">Global Agricultural Lands in the Year 2000</a></p></li>
<li><p>Also consider <a class="reference external" href="https://www.atmos.illinois.edu/~meiyapp2/datasets.htm">gridded land use datasets</a></p></li>
</ul>
</li>
<li><p>📚  Look at the <a class="reference external" href="https://iridl.ldeo.columbia.edu/">IRI Data Library</a> for a large variety of datasets, available in any format.</p></li>
</ul>
</section>
<section id="working-with-gridded-weighting-data">
<span id="content-working-with-gridded-data"></span><h2>Working with gridded weighting data<a class="headerlink" href="#working-with-gridded-weighting-data" title="Permalink to this heading">#</a></h2>
<p>Weighting data files come in a wide range of file formats, since any
gridded data file can be used as a weighting scheme. The most common
data types are CSV, ASC, GeoTIFF, and BIL files. In each case, you (or
your code) need to know (1) the format of the data values, (2) the
spatial gridding scheme, (3) the projection, and (4) how missing data
is handled. These are described in the sections below.</p>
<section id="the-format-of-the-data-values">
<h3>The format of the data values<a class="headerlink" href="#the-format-of-the-data-values" title="Permalink to this heading">#</a></h3>
<p>Data values can be written out in text (as with CSV and ASC files) or
in a binary representation (GeoTIFF and BIL). If the values are
written as text, delimiters will be used to separate them (comma for
CSV, spaces for ASC).</p>
</section>
<section id="the-spatial-gridding-scheme">
<h3>The spatial gridding scheme<a class="headerlink" href="#the-spatial-gridding-scheme" title="Permalink to this heading">#</a></h3>
<p>The spatial gridding scheme is determined by 6 numbers: a latitude and longitude of an origin point, a horizontal and vertical cell lengths, and a number of rows and columns.
- The most common origin point is the location of the lower-left corner of the lower-left grid cell. For example, for a global dataset, that might be 90°S, 180°W, which is represented in x, y coordinates as (-180, -90). Sometimes (particularly with NetCDF files), grid cell center locations will be used instead.
- Grid cell sizes are often given as decimal representation of fractions of a degree, such as <span class="math notranslate nohighlight">\(0.0083333333333 = 1 / 120\)</span> of a degree. This is the grid cell size needed globally to ensure a km-scale resolution. Usually the horizontal and vertical grid cell lengths are the same, and reported as a single number.
- The number of grid cells is the most common way to describe the spatial coverage of the dataset. A global dataset will have 180 / cellsize rows and 360 / cellsize columns.</p>
<p>Based on this information, you can calculate which grid cell any point on the globe falls into:</p>
<div class="math notranslate nohighlight">
\[\text{row} = \text{floor}\left(\frac{\text{Latitude} - y_0}{\text{CellSize}}\right),\]</div>
<div class="math notranslate nohighlight">
\[\text{column} = \text{floor}\left(\frac{\text{Longitude} - x_0}{\text{CellSize}}\right)\]</div>
<p>where <span class="math notranslate nohighlight">\(x_0, y_0\)</span> is lower-left corner point. If the center of the lower-left cell was given, <span class="math notranslate nohighlight">\(x_0 = x_\text{llcenter} - \frac{\text{CellSize}}{2}\)</span>, <span class="math notranslate nohighlight">\(y_0 = y_\text{llcenter} - \frac{\text{CellSize}}{2}\)</span>.</p>
<p>For CSV files, you will need to keep track of this data yourself. ASC files have it at the top of the file, BIL files have a corresponding HDR file with the data, and GeoTIFF files have it embedded in the file which you can read with various software tools.</p>
</section>
<section id="the-geographic-projection">
<h3>The geographic projection<a class="headerlink" href="#the-geographic-projection" title="Permalink to this heading">#</a></h3>
<p>Projections are a way to map points on the globe (in
latitude-longitude space) to a point in a flat x, y space. While this
is important for visualizing maps, it can just be a nuisance for
gridded datasets. The most common “projection” for gridded datasets is
an equirectangular projection, and we have been assuming this
above. This is variously referred to as <code class="docutils literal notranslate"><span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">ll</span></code>, <code class="docutils literal notranslate"><span class="pre">WGS</span> <span class="pre">84</span></code>, and
<code class="docutils literal notranslate"><span class="pre">EPSG:</span> <span class="pre">4326</span></code> (technically, WGS 84 specifies how latitude and longitude
are defined, and EPSG:4326 specifies a drawing scheme where x =
longitude and y = latitude). However, you will sometimes encounter
grids in terms of km north and km east of a point, and then you may
need to project these back to latitude-longitude and regrid them.</p>
</section>
<section id="handling-of-missing-data">
<h3>Handling of missing data<a class="headerlink" href="#handling-of-missing-data" title="Permalink to this heading">#</a></h3>
<p>All of these allow missing data to be handled. Typically, a specific numerical representation, like -9999, will be used. This is specified the same way that the gridding scheme is.</p>
</section>
<section id="implementation-notes-reading-gridded-data">
<h3>Implementation Notes: Reading gridded data.<a class="headerlink" href="#implementation-notes-reading-gridded-data" title="Permalink to this heading">#</a></h3>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
R</label><div class="sd-tab-content docutils">
<p>Use the <code class="docutils literal notranslate"><span class="pre">raster</span></code> library. For example:</p>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
<span class="n">rr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">raster</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>If you are using R, take a look at the <a class="reference external" href="https://datacarpentry.org/r-raster-vector-geospatial/">Introduction to Geospatial Raster and Vector Data with R</a>,
which has some extensive examples of working with geospatial raster data.</p>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
Python</label><div class="sd-tab-content docutils">
<p>Take a look at <a class="github reference external" href="https://github.com/jrising/research-common/tree/master/python/geogrid">jrising/research-common</a>.</p>
</div>
</div>
<p>In some cases, it is appropriate and possible to use time-varying weighting schemes. For example, if population impacts are being studied, and the scale of the model is individuals, annual estimate of population can be used. This kind of data is often either in NetCDF format (see above), or as a collection of files.</p>
</section>
</section>
<section id="aligning-weather-and-weighting-grids">
<h2>Aligning weather and weighting grids<a class="headerlink" href="#aligning-weather-and-weighting-grids" title="Permalink to this heading">#</a></h2>
<p>The first step to using a gridded weighting dataset is to make it
conform to the data grid definition used by your weather data.  This
generally requires resampling the weighting data, increasing its
resolution by some factor. You want to do this so that two conditions to be met after resampling: (A) The new resolution should be an integer multiple of the weather resolution. (B) The horizontal and meridional grid lines of the weather data coincide with the resampled grid lines of the weighting data.</p>
<p>Here we assume that both are regular latitude-longitude
grids. See <a class="reference internal" href="#content-working-with-gridded-data"><span class="std std-ref">working with gridded weighting data</span></a> to
understand the grid scheme for your weighting file; note that gridded
weather data often reports the center of each grid cell, rather than
the corner.</p>
<p>If your datasets cover the same geographic extent, and if the
resolution of your weighting dataset is an even multiple of the
resolution of your weather dataset, your job is easy. Just either
aggregate or disaggregate grid cells so that they have the same
resolution as the weather data, using the code below. In other cases,
you will need to follow three steps, and generally require
upsampling, downsampling, and cropping.</p>
<section id="upsampling-increasing-data-resolution">
<h3>Upsampling - increasing data resolution<a class="headerlink" href="#upsampling-increasing-data-resolution" title="Permalink to this heading">#</a></h3>
<p>To increase the resolution of a grid <code class="docutils literal notranslate"><span class="pre">rr</span></code> by a factor of <code class="docutils literal notranslate"><span class="pre">N</span></code> without increasing the
sum of grid cells:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-2" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-2">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">rr2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">disaggregate</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="w"> </span><span class="n">fact</span><span class="o">=</span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="o">^</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-3" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-3">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="downsampling-decreasing-data-resolution">
<h3>Downsampling - decreasing data resolution<a class="headerlink" href="#downsampling-decreasing-data-resolution" title="Permalink to this heading">#</a></h3>
<p>To decrease the resolution of a grid <code class="docutils literal notranslate"><span class="pre">rr</span></code> by a factor of <code class="docutils literal notranslate"><span class="pre">N</span></code> without
decreasing the sum of grid cells:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-4" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-4">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">rr2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="w"> </span><span class="n">fact</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="o">=</span><span class="n">sum</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-5" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-5">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">N</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">N</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">rr2</span> <span class="o">+=</span> <span class="n">rr</span><span class="p">[</span><span class="n">ii</span><span class="p">::</span><span class="n">N</span><span class="p">,</span> <span class="n">ii</span><span class="p">::</span><span class="n">N</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cropping-adjusting-the-extent-of-data">
<h3>Cropping - adjusting the extent of data<a class="headerlink" href="#cropping-adjusting-the-extent-of-data" title="Permalink to this heading">#</a></h3>
<p>To adjust the spatial extent of grid <code class="docutils literal notranslate"><span class="pre">rr</span></code> to conform as closely as possible
to a box from the longitudinal range <code class="docutils literal notranslate"><span class="pre">WW</span></code> to <code class="docutils literal notranslate"><span class="pre">EE</span></code> and the latitudinal
range from <code class="docutils literal notranslate"><span class="pre">SS</span></code> to <code class="docutils literal notranslate"><span class="pre">NN</span></code>.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-6" name="sd-tab-set-3" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-6">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">rr2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="w"> </span><span class="nf">extent</span><span class="p">(</span><span class="n">WW</span><span class="p">,</span><span class="w"> </span><span class="n">SS</span><span class="p">,</span><span class="w"> </span><span class="n">EE</span><span class="p">,</span><span class="w"> </span><span class="n">NN</span><span class="p">))</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-7" name="sd-tab-set-3" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-7">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We need to know the original extent of the data (W0, S0, E0, N0) and the spatial resolution (D)</span>

<span class="n">rr2</span> <span class="o">=</span> <span class="n">rr</span><span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">SS</span> <span class="o">-</span> <span class="n">S0</span><span class="p">)</span><span class="o">/</span><span class="n">D</span><span class="p">):</span><span class="nb">int</span><span class="p">((</span><span class="n">NN</span> <span class="o">-</span> <span class="n">S0</span><span class="p">)</span><span class="o">/</span><span class="n">D</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">WW</span> <span class="o">-</span> <span class="n">W0</span><span class="p">)</span><span class="o">/</span><span class="n">D</span><span class="p">):</span><span class="nb">int</span><span class="p">((</span><span class="n">EE</span> <span class="o">-</span> <span class="n">W0</span><span class="p">)</span><span class="o">/</span><span class="n">D</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>The following recipe should work for most cases to align weighting data with a weather grid.</p>
<ol class="arabic simple">
<li><p><strong>Upsample the weighting data until the grid of the weighting data evenly divides up the weather data.</strong> Start by considering the southwest corner of each dataset. Even if the
datasets are of the same resolution, upsampling may be required to
make the grid cells line up. For example, if the weighting data has a
southwest corner of (0 N, 0 E) and a resolution of <span class="math notranslate nohighlight">\(1\)</span> degree, while the weather data starts at (0.5
N, 0.5 E) and a resolution of <span class="math notranslate nohighlight">\(1\)</span> degree, the weighting data will need
to be upsampled by a factor of <span class="math notranslate nohighlight">\(2\)</span>, so that it provides a grid line at
(0.5 N, 0.5 E).</p></li>
<li><p><strong>Clip the two datasets so that they line up.</strong> After step 1, it should be possible to clip the two datasets to the
exact same extent.</p></li>
<li><p><strong>Re-aggregate the weighting data.</strong> Now, downsample the weighting data to the resolution of the weather data.</p></li>
</ol>
</section>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this heading">#</a></h3>
<p>Suppose the weather data is nearly global, from 180°W to 180°E, 90°S to 86°N, as the case with LandScan population data. The resolution is 1/120th of a degree. You want to use this to weight PRISM data for the USA, with an extent <span class="math notranslate nohighlight">\(125.0208\)</span> to 66.47917°W, 24.0625 to 49.9375°N, with a resolution of 1/24th of a degree.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-8" name="sd-tab-set-4" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-8">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">landscan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">raster</span><span class="p">(</span><span class="s">&quot;…/w001001.adf&quot;</span><span class="p">)</span>
<span class="n">landscan</span>
<span class="c1">## class       : RasterLayer</span>
<span class="c1">## dimensions  : 21120, 43200, 912384000  (nrow, ncol, ncell)</span>
<span class="c1">## resolution  : 0.008333333, 0.008333333  (x, y)</span>
<span class="c1">## extent      : -180, 180, -90, 86  (xmin, xmax, ymin, ymax)</span>
<span class="n">prism</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">raster</span><span class="p">(</span><span class="s">&quot;PRISM_tmax_stable_4kmM2_2000_all_asc&quot;</span><span class="p">)</span>
<span class="n">prism</span>
<span class="c1">## class       : RasterLayer</span>
<span class="c1">## dimensions  : 621, 1405, 872505  (nrow, ncol, ncell)</span>
<span class="c1">## resolution  : 0.04166667, 0.04166667  (x, y)</span>
<span class="c1">## extent      : -125.0208, -66.47917, 24.0625, 49.9375  (xmin, xmax, ymin, ymax)</span>
</pre></div>
</div>
</div>
</div>
<p>Start by throwing away extraneous data, by cropping the LandScan to, say,
126 to 66°W, 24 to 50°N.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-9" name="sd-tab-set-5" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-9">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">landscan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span><span class="n">landscan</span><span class="p">,</span><span class="w"> </span><span class="nf">extent</span><span class="p">(</span><span class="m">-126</span><span class="p">,</span><span class="w"> </span><span class="m">-66</span><span class="p">,</span><span class="w"> </span><span class="m">24</span><span class="p">,</span><span class="w"> </span><span class="m">50</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now, note that the edge of the PRISM data is in the middle of the LandScan grid cells:
<span class="math notranslate nohighlight">\(120 * (180 - 125.0208) = 6597.5\)</span>
That means that you need to increase the resolution of the LandScan data by 2 to line it up. In general, you will need to increase it by 1 / (the trailing decimal).</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-10" name="sd-tab-set-6" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-10">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">landscan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">disaggregate</span><span class="p">(</span><span class="n">landscan</span><span class="p">,</span><span class="w"> </span><span class="n">fact</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">4</span>
</pre></div>
</div>
</div>
</div>
<p>We divide by 4 so that the total population remains the same.</p>
<p>After increasing the resolution of the LandScan data, we clip it again.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-11" name="sd-tab-set-7" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-11">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">landscan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">crop</span><span class="p">(</span><span class="n">landscan</span><span class="p">,</span><span class="w"> </span><span class="nf">extent</span><span class="p">(</span><span class="m">-125.0208</span><span class="p">,</span><span class="w"> </span><span class="m">-66.47917</span><span class="p">,</span><span class="w"> </span><span class="m">24.0625</span><span class="p">,</span><span class="w"> </span><span class="m">49.9375</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now, the resolution of the dataset has become 1/240th, and we can
write aggregate by a factor of <span class="math notranslate nohighlight">\(10\)</span> for it to match the PRISM data:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-12" name="sd-tab-set-8" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-12">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="n">landscan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="n">landscan</span><span class="p">,</span><span class="w"> </span><span class="n">fact</span><span class="o">=</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="o">=</span><span class="n">sum</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="plotting-your-results">
<h2>Plotting your results<a class="headerlink" href="#plotting-your-results" title="Permalink to this heading">#</a></h2>
<p>Now take a moment to visualize the data that you have created. This is
a good way to make sure you haven’t made any mistakes and to wow your
less climate-adept colleagues in presentations.</p>
<p>To get an initial view of your data, you can just plot your data as a
matrix. In R, use the <code class="docutils literal notranslate"><span class="pre">image</span></code> function; similar functions exist in
other languages. The trick is to make sure that you specify the
coordinates when you plot the map.</p>
<p>Here’s an easy case, using population data from the <a class="reference external" href="https://sedac.ciesin.columbia.edu/data/set/gpw-v4-population-density-adjusted-to-2015-unwpp-country-totals-rev11/data-download">Gridded
Population of the
World</a>
dataset.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-13" name="sd-tab-set-9" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-13">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
<span class="c1">## Load the data</span>
<span class="n">rr</span><span class="w"> </span><span class="o">&lt;-</span>
<span class="nf">raster</span><span class="p">(</span><span class="s">&quot;gpw_v4_population_density_adjusted_to_2015_unwpp_country_totals_rev11_2020_2pt5_min.asc&quot;</span><span class="p">)</span>

<span class="c1">## Display it!</span>
<span class="nf">image</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="Result of ." src="../_images/image-gpw.png" /></p>
</div>
</div>
<p>But that wasn’t any fun. Let’s try again with something more
complicated.</p>
<p>First, we’ll download <a class="reference external" href="https://iridl.ldeo.columbia.edu/SOURCES/.NOAA/.NCEP-NCAR/.CDAS-1/.pc6190/.Diagnostic/.above_ground/.maximum/.temp/%5BT+%5Daverage/">historical maximum temperature</a> data from the
easy-to-use IRI data library.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-14" name="sd-tab-set-10" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-14">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">ncdf4</span><span class="p">)</span>

<span class="c1">## Load the data</span>
<span class="n">nc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">nc_open</span><span class="p">(</span><span class="s">&quot;data.nc&quot;</span><span class="p">)</span>
<span class="n">temp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ncvar_get</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;temp&#39;</span><span class="p">)</span>

<span class="c1">## Display it!</span>
<span class="nf">image</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="Result of ." src="../_images/image-tmax.png" /></p>
</div>
</div>
<p>This is R’s default way of showing matrices, with axes that go from
0 - 1. What’s worse, the map is up-side-down, though it will take some
staring to convince yourself ot this. The reason is that NetCDFs
usually have the upper-left corner representing the extreme
North-West. But R’s <code class="docutils literal notranslate"><span class="pre">image</span></code> command shows the upper-left corner in the
lower-left.</p>
<p>We are also going to plot the countries, so this is easier to
interpret. And to do that, we need to rearrange the data so it goes
from -180 to 180, rather than 0 to 360 as currently. Here’s our second
attempt:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-15" name="sd-tab-set-11" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-15">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1">## Extract the coordinate values</span>
<span class="n">lon</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ncvar_get</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;X&quot;</span><span class="p">)</span>
<span class="n">lat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ncvar_get</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Y&quot;</span><span class="p">)</span>

<span class="c1">## Rearrange longitude to go from -180 to 180</span>
<span class="n">lon2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="n">lon</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">180</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">360</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="p">[</span><span class="n">lon</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">180</span><span class="p">])</span>
<span class="n">temp2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rbind</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">lon</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">180</span><span class="p">,],</span><span class="w"> </span><span class="n">temp</span><span class="p">[</span><span class="n">lon</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">180</span><span class="p">,])</span>

<span class="c1">## Display it, with map!</span>
<span class="nf">library</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span>
<span class="nf">image</span><span class="p">(</span><span class="n">lon2</span><span class="p">,</span><span class="w"> </span><span class="nf">rev</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span><span class="w"> </span><span class="n">temp2</span><span class="p">[,</span><span class="nf">ncol</span><span class="p">(</span><span class="n">temp2</span><span class="p">)</span><span class="o">:</span><span class="m">1</span><span class="p">])</span>
<span class="nf">map</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="o">=</span><span class="bp">T</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="Result after ." src="../_images/image-tmax-flip.png" /></p>
</div>
</div>
<p>Now, for our production-ready map, we’re going to switch to
<code class="docutils literal notranslate"><span class="pre">ggplot2</span></code>. In <code class="docutils literal notranslate"><span class="pre">ggplot</span></code>, all data needs to be as dataframes, so we need
to convert the matrix into a dataframe (with <code class="docutils literal notranslate"><span class="pre">melt</span></code>) and the map into
a dataframe (with <code class="docutils literal notranslate"><span class="pre">map_data</span></code>):</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-16" name="sd-tab-set-12" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-16">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1">## Convert temp2 to a dataframe</span>
<span class="nf">library</span><span class="p">(</span><span class="n">reshape2</span><span class="p">)</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">temp2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lon2</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">temp2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lat</span>
<span class="n">temp3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">melt</span><span class="p">(</span><span class="n">temp2</span><span class="p">,</span><span class="w"> </span><span class="n">varnames</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;lon&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;lat&#39;</span><span class="p">))</span>

<span class="c1">## Convert world map to a dataframe</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggmap</span><span class="p">)</span>
<span class="n">world</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">map_data</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">)</span>

<span class="c1">## Plot everything</span>
<span class="nf">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">geom_raster</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">temp3</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">geom_polygon</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">world</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="Result after ." src="../_images/ggplot-tmax.png" /></p>
</div>
</div>
<p>And now we’re ready to production-ready graph! The biggest change
will be the addition of a map projection. As mentioned above, map
projections translate points on a globe into points on a screen. You’ll want to choose your
projection carefully, since people are bound to judge you for
it.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Choosing a map projection is beyond the scope of this tutorial, however, you can take a
look at this <a class="reference external" href="http://www.geo.hunter.cuny.edu/~jochen/gtech201/lectures/lec6concepts/map%20coordinate%20systems/how%20to%20choose%20a%20projection.htm">overview from Jochen Albrecht</a> or how Randall Munroe <a class="reference external" href="https://imgs.xkcd.com/comics/map_projections.png">thinks about them</a>.</p>
</div>
<figure class="align-default" id="id1">
<img alt="https://imgs.xkcd.com/comics/map_projections.png" src="https://imgs.xkcd.com/comics/map_projections.png" />
<figcaption>
<p><span class="caption-number">Fig. 3 </span><span class="caption-text">Considerations for projections. Source: <a class="reference external" href="https://www.xkcd.com/977/">XKCD 977</a>.</span><a class="headerlink" href="#id1" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Using the projection, we can now make the final version of this
figure. Note that you will need to use <code class="docutils literal notranslate"><span class="pre">geom_tile</span></code> rather than
<code class="docutils literal notranslate"><span class="pre">geom_raster</span></code> when plotting grids over projections, and this can be
quite a bit slower. We use a color palette from
<a class="reference external" href="http://colorbrewer2.org/">ColorBrewer</a>, which is an excellent resource for
choosing colors.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-17" name="sd-tab-set-13" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-17">
R</label><div class="sd-tab-content docutils">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span>
<span class="nf">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">geom_tile</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">temp3</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="n">value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">273.15</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">geom_polygon</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">world</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="o">=</span><span class="n">.</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">coord_map</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s">&quot;mollweide&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">-65</span><span class="p">,</span><span class="w"> </span><span class="m">65</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">xlim</span><span class="p">(</span><span class="m">-180</span><span class="p">,</span><span class="w"> </span><span class="m">180</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">theme_light</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">theme</span><span class="p">(</span><span class="n">panel.ontop</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">panel.background</span><span class="o">=</span><span class="nf">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">xlab</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">ylab</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">    </span><span class="nf">scale_fill_distiller</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Average\nMax T.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">palette</span><span class="o">=</span><span class="s">&quot;YlOrRd&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="w"> </span><span class="n">legend.position</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">.</span><span class="m">01</span><span class="p">,</span><span class="n">.</span><span class="m">01</span><span class="p">))</span>
</pre></div>
</div>
<p><img alt="Result after ." src="../_images/ggplot-tmax-final.png" /></p>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="working-with-shapefiles.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Constructing weather averages within spatial units</p>
      </div>
    </a>
    <a class="right-next"
       href="example-step3.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Hands-On Exercise, Step 3: Aggregating the data</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-spatial-weighting-schemes-matter">Why spatial weighting schemes matter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#where-to-get-spatial-weighting-data">Where to get spatial weighting data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-gridded-weighting-data">Working with gridded weighting data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-format-of-the-data-values">The format of the data values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-spatial-gridding-scheme">The spatial gridding scheme</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-geographic-projection">The geographic projection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-of-missing-data">Handling of missing data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-notes-reading-gridded-data">Implementation Notes: Reading gridded data.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aligning-weather-and-weighting-grids">Aligning weather and weighting grids</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upsampling-increasing-data-resolution">Upsampling - increasing data resolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#downsampling-decreasing-data-resolution">Downsampling - decreasing data resolution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cropping-adjusting-the-extent-of-data">Cropping - adjusting the extent of data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example">Example</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-your-results">Plotting your results</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2020.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>